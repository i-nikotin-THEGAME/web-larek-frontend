# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных используемые в приложении

Интерфейс для карирчки товара
```
interface ICard {
	id: string;
	description: string;
	image: string;
	title: string;
	category: string;
	price: number;
	isSelected: boolean;
}
```
Интерфейс для отправки готового заказа для отправки на сервер

```
interface IOrder {
	payment: string;
	email: string;
	phone: string;
	address: string;
	total: number;
	items: string[];
}
```
Тип данных товара испльзуемые для отображения предварительного просмотра карточки в модальном окне

```
type TCardFull = Pick<ICard, 'id' | 'title' | 'price' | 'image' | 'category' | 'description'>;
```
Данные товара для отображения списка карточек в корзине

```
type TBaskeCompact = Pick<ICard, 'id' | 'title' | 'price'>;
```

Данные пользователя для оформления заказа

```
type TFormOrder = Pick<IOrder, 'payment' | 'address'>;
type TFormContact = Pick<IOrder, 'email' | 'phone'>;
```

## Архитектура приложения

Код приложения разделен на слои гласно парадигме MVP:
- слой представления, отвечате за представление данных на странице,
- слой данных, отвечате за хранение и изменение данных,
- презентер, отвечате за связи представления и данные.

### Базовый код

#### Класс `Api`
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:
- `get` - выполняет `GET` запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер,
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на эндпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс `EventEmitter`
Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков о наступлении события.
Класс имеет методы:
- `on` — для подписки на событие,
- `off` — для отписки от события,
- `emit` — уведомления подписчиков о наступлении события.

Дополнительно реализованы методы:
- `onAll` —  для подписки на все события,
- `offAll` —  для сброса всех подписчиков.

Дополнительно есть метод `trigger` , генерирующий заданное событие с заданными аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти классы будут генерировать события, не будучи при этом напрямую зависимыми от класса `EventEmitter`.

### Слой данных

#### Класс CardsData

Класс отвечает за хранение и логику работы с данными карточек.\
Конструктор класса принимает инстант брокера событий.\

В полях класса хранятся следующие данные:
- `_cards: ICard[]` - массив объектов карточек,
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:
- `getCard(cardId: string): ICard` - возвращает карточку по ее id,
- `getPrice(cardId: string): number` - возвращает цену товара по id,
- `setCardSelectedState(cardId: string, state: boolean): void` - устанавливает состояние добавленной карточки в корзину,
- `resetAllSelectedStates(): void` - сбрасывает все состояние карточек в дефолтное состояние,
- а так-же `сеттеры` для сохранения данных в поля класса.

#### Класс OrderData

Класс отвечает за хранение и логику работы с данными заказа, необходимых для отправки на сервер.\
Конструктор класса принимает инстант брокера событий.\

В полях класса хранятся следующие данные:
- `payment: string` - хранит данный о способе оплаты,
- `email: string` - хранит данный об электронной почте,
- `phone: string` - хранит данный о номере телефона,
- `address: string` - хранит данный об адресе,
- `total: number = 0` - хранит данный об общей стоимости покупок,
- `items: string[] = []` - массив id с выбранными товарами для оплаты пользователем,
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:
- `addItem(item: string): void` - метод добавляет товар в поле items и проверяет уникальность,
- `deleteItem(item: string | null): void`- метод удаляет товар если пользователь его удалил из корзины,
- `getItems(): string[]` - метод возвращает массив с id, необходим для отрисовки списка выбранных товаров в корзине,
- `checkOrderValidation(): boolean` - метод проверяет валидность формы с данными об оплате и данными об адресе, если форма не валидна, то кнопка "Далее" не активна,
- `checkContactValidation(): boolean` - метод проверяет валидность формы с данными о номере телефона и адресе электронной почты, если форма не валидна, то кнопка "Оплатить" не активна,
- `checkFieldOrder(): string` - проверяется валидность полей формы с методом оплаты и адресом для вывода подсказок для пользователя,
- `checkFieldContact(): string` - проверяется валидность полей формы с номером телефона и адресом электронной почты для вывода подсказок для пользователя,
- `clearOrder(): void` - метод очистки данных после успешного оформления заказа, если отчет с сервера не получил ошибок.
- а так-же `сеттеры` и `геттеры` для сохранения и получения данных из полей класса.

### Слой представления

Все классы представления отвечают за отображение вутри контейнера (DOM-екмент) переданных в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Modal

Реализует модальное окно.\
Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.

- `constructor(selector: string, events: IEvents)` Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса
- `content: HTMLElement` - элемент модального окна,
- `events: IEvents` - брокер событий.

#### Класс Page
Отвечает за отображение блока с карточками на главной странице.\
В конструктор принимает контейнер, в котором размещаются карточки.\
Сеттеры изменяют счетчик при изменении данных в корзине, заполняют главную страницу карточками, блокируют прокрутку страницы при открытии модального окна.


#### Класс Basket
Расширяет класс `Component`. Предназначен для реализации модального окна отображения корзины с купленными товарами.

Поля класса:
- `list: HTMLElement` - элемент формы в котором будут отображаться списко товаров,
- `totalElement: HTMLElement` - элемент формы, в котором отображается итогова сумма всех товаров,
- `button: HTMLButtonElement` - кнопка перехода для оформления заказа.

Методы:
- `updatwBasketItems(basketList: HTMLElement[]): void `- перерисовывает модальное окно с корзиной, присваиет порядковый номер списка в соответствии со количеством товара в корзине,
- `updateTotal(data: number): void` - обновляет сумму товаров в корзине при изменении и удалении товаров.

#### Класс Order
Расширяет класс `Component`. Предназначен для реализации модального окна с формой содержащей поля ввода. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных.\
Предоставляет методы для отображения ошибок и управления активностью кнопки подтверждения.\
Поля класса:
- `inputs: NodeListOf<HTMLInputElement>` - поля ввода форм,
- `payment: NodeListOf<HTMLButtonElement>` - все кнопки форм с типом `button`,
- `activePaymentButton: HTMLButtonElement | null = null` - кнопки формы для выбора метода оплаты,
- `errors: HTMLElement` - поле вывода текста валидации,
- `formName: string` - поле с названием форм,
- `submitButton: HTMLButtonElement` - все кнопки форм с типом `submit`,
- `successButton: HTMLButtonElement | null = null` - кнопка закрытия формы с успешной оплаты заказа,
- `successDescription: HTMLElement` - элемент формы.

Методы:
- `checkedPayment(target: HTMLButtonElement): { payment: string }` - метода возвращает выбранный способ оплаты,
- `getInputValues(): Record<string, string>` - возвращает объект с данными из полей формы, где ключ - `name` инпута, значение - данные введенные пользователем,
- `set error(validInformation: string)` - сеттер показывающий поле с ошибками либо скриывающий его,
- `showInputError (field: string, errorMessage: string): void` - отображает полученный текст ошибки,
- `hideInputError (field: string): void` - очищает текст ошибки,
- `resetForm(): void` - метод при отправки заказа на сервер очищает поля формы и приводит в дефолтное состояние кнопку выбора способа оплаты.

#### Класс Card 
Отвечает за отображение карточки, задавая в карточке данные названия, изображения, категории, подробное описание и цены.\
Класс используется для отображения карточек на странице сайта.\
В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. В классе устанавливаются слушатели на просмотр подробного описания товара и добавления его в корзину, в результате взаимодействия с которыми пользователя генерируются соответствующие события. Если цена товара ровна `null` то кнопка Купить не активна\

Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.\

Методы:
- `render(data?: Partial<ICard>): HTMLElement` - расширяет родительский метод, обрабатывая отдельно данные категории товара, остальные данные передаются в родительский метод. Метод возвращает разметку карточки с установленными слушателями,
- `resetCardButton(): void` - сбрасывает активность кнопки в дефолтное состояние,
- геттер _id возвращает уникальный id карточки

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*

- `cards:changed` - изменение массива карточек,
- `card-basket:changed` - изменение массива списка товара в корзине,
- `initialData:loaded` - сообщает о получении данных с сервеа и инициализирует первоначальную загрузку карточек на странице.

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*

События открытия модальных окон:
- `card-preview:open` - открытие модального окна просмотра информации о товаре,
- `basket:open` - открытие модального окна просмотра корзины,
- `order:open` - открытие модального окна с формой оформления заказа: выбор способа оплаты и указание адреса доставки,
- `order:submit` - открытие модального окна с формой оформления заказа: ввод электронной почты и ввод номера телефона.
- `contacts:submit` - подтверждение заверешения ввода данных в форме ввода электронной почты и телефона и перехода к оплате.
- `success:close` - закрывается модальное окно об успешной отправке заказа.

События внутри модальных окон:
- `item-basket:add` - добавление товара в корзину,
- `item-basket:delete` - удаление товара из корзины,
- `basket:changed` - изменился состав товаров в корзине,
- `order-payment:checked` - выбор способа оплаты card или cash,
- `order:input` - изменение данных в форме выбора способа оплаты и ввода адреса доставки,
- `contacts:input` - изменение данных в форме ввода электронной почты и телефона.